---
# This workflow runs security scans including dependency vulnerability scanning,
# secret detection, and container vulnerability scanning.
# It is called by the build.yml workflow and can also be triggered independently.
# Workflow linting (actionlint) is handled by pre-commit (see .pre-commit-config.yaml).
# Dockerfile linting (hadolint) is handled by docker-validate.yml.
# Covers issue #72: https://github.com/SimplicityGuy/discogsography/issues/72
name: Security

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches:
      - main
    paths:
      - "**/*.py"
      - "**/pyproject.toml"
      - "**/uv.lock"
      - "extractor/**/*.rs"
      - "extractor/**/Cargo.toml"
      - "extractor/**/Cargo.lock"
      - "**/Dockerfile"
      - ".github/workflows/security.yml"
  pull_request:
    branches:
      - main
    paths:
      - "**/*.py"
      - "**/pyproject.toml"
      - "**/uv.lock"
      - "extractor/**/*.rs"
      - "extractor/**/Cargo.toml"
      - "extractor/**/Cargo.lock"
      - "**/Dockerfile"
      - ".github/workflows/security.yml"
  schedule:
    - cron: "0 4 * * 1" # Weekly Monday 04:00 UTC

env:
  CI: true
  PYTHON_VERSION: "3.13"

permissions:
  contents: read
  security-events: write # Required for SARIF uploads to GitHub Security tab

jobs:
  python-security:
    name: Python Security
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ”€ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ”§ Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          uv sync --all-extras
          uv pip install -e api
          uv pip install -e common
          uv pip install -e curator
          uv pip install -e dashboard
          uv pip install -e explore

      - name: ğŸ” Run pip-audit (Python dependency vulnerability scan)
        run: uv run pip-audit --desc

      - name: ğŸ›¡ï¸ Run bandit (Python SAST)
        run: uv run bandit -r . -c pyproject.toml

      - name: ğŸ”¬ Run semgrep (enhanced Python SAST)
        uses: semgrep/semgrep-action@v1
        with:
          config: "p/security-audit p/python p/owasp-top-ten"

      - name: ğŸ”§ Setup Go (for osv-scanner)
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: false

      - name: ğŸŒ Run osv-scanner (multi-ecosystem vulnerability scan)
        run: |
          go install github.com/google/osv-scanner/cmd/osv-scanner@latest
          osv-scanner scan --lockfile=uv.lock --lockfile=extractor/Cargo.lock .

  rust-security:
    name: Rust Security
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ”€ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ¦€ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Rust dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            extractor/target/
          key: ${{ runner.os }}-cargo-security-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-security-
            ${{ runner.os }}-cargo-

      - name: ğŸ“¦ Install cargo-audit and cargo-deny
        run: cargo install cargo-audit cargo-deny

      - name: ğŸ” Run cargo-audit (Rust advisory database scan)
        working-directory: extractor
        run: cargo audit

      - name: ğŸ›¡ï¸ Run cargo-deny (Rust license and policy check)
        working-directory: extractor
        run: cargo deny check

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ”€ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history required for comprehensive secret scanning

      - name: ğŸ”‘ Run TruffleHog (secret detection)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

  container-scanning:
    name: Container Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ”€ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ›¡ï¸ Run trivy (filesystem vulnerability scan)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-results.sarif
          severity: HIGH,CRITICAL

      - name: ğŸ“¤ Upload trivy SARIF results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
