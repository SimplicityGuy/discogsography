---
# This is the primary test workflow that runs all unit and integration tests.
# It is called by the build.yml workflow and can also be triggered independently.
# For E2E and browser testing, see e2e-test.yml.
#
# All service test jobs run in PARALLEL to minimize total workflow time.
# Each service has its own isolated test job that can run independently.
name: Test

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches:
      - main
    paths:
      - "**/*.py"
      - "**/pyproject.toml"
      - "**/uv.lock"
      - "extractor/**/*.rs"
      - "extractor/**/Cargo.toml"
      - ".github/workflows/test.yml"
  pull_request:
    branches:
      - main
    paths:
      - "**/*.py"
      - "**/pyproject.toml"
      - "**/uv.lock"
      - "extractor/**/*.rs"
      - "extractor/**/Cargo.toml"
      - ".github/workflows/test.yml"

env:
  CI: true
  PYTHON_VERSION: "3.13"

permissions:
  contents: read
  pull-requests: write  # Required for coverage report comments

jobs:
  # ============================================================================
  # API SERVICE TESTS - Runs in parallel with all other test jobs
  # ============================================================================
  test-api:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîß Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Setup Just
        uses: ./.github/actions/setup-just

      - name: üì¶ Install dependencies
        run: just install

      - name: üß™ Run api tests
        run: just test-api

      - name: üìä Upload coverage (api)
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./coverage.xml
          flags: api
          name: api-tests
          fail_ci_if_error: false
          disable_search: true
          verbose: false

  # ============================================================================
  # CURATOR SERVICE TESTS - Runs in parallel with all other test jobs
  # ============================================================================
  test-curator:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîß Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Setup Just
        uses: ./.github/actions/setup-just

      - name: üì¶ Install dependencies
        run: just install

      - name: üß™ Run curator tests
        run: just test-curator

      - name: üìä Upload coverage (curator)
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./coverage.xml
          flags: curator
          name: curator-tests
          fail_ci_if_error: false
          disable_search: true
          verbose: false

  # ============================================================================
  # COMMON/SHARED LIBRARY TESTS - Runs in parallel with all other test jobs
  # ============================================================================
  test-common:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîß Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Setup Just
        uses: ./.github/actions/setup-just

      - name: üì¶ Install dependencies
        run: just install

      - name: üß™ Run common tests
        run: just test-common

      - name: üìä Upload coverage (common)
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./coverage.xml
          flags: common
          name: common-tests
          fail_ci_if_error: false
          disable_search: true
          verbose: false

  # ============================================================================
  # DASHBOARD SERVICE TESTS - Runs in parallel with all other test jobs
  # ============================================================================
  test-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîß Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Setup Just
        uses: ./.github/actions/setup-just

      - name: üì¶ Install dependencies
        run: just install

      - name: üé≠ Install Playwright browsers
        run: |
          uv run playwright install chromium
          uv run playwright install-deps chromium

      - name: üß™ Run dashboard tests
        run: just test-dashboard

      - name: üìä Upload coverage (dashboard)
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./coverage.xml
          flags: dashboard
          name: dashboard-tests
          fail_ci_if_error: false
          disable_search: true
          verbose: false

  # ============================================================================
  # EXPLORE SERVICE TESTS - Runs in parallel with all other test jobs
  # ============================================================================
  test-explore:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîß Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Setup Just
        uses: ./.github/actions/setup-just

      - name: üì¶ Install dependencies
        run: just install

      - name: üß™ Run explore tests
        run: just test-explore

      - name: üìä Upload coverage (explore)
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./coverage.xml
          flags: explore
          name: explore-tests
          fail_ci_if_error: false
          disable_search: true
          verbose: false

  # ============================================================================
  # GRAPHINATOR SERVICE TESTS - Runs in parallel with all other test jobs
  # ============================================================================
  test-graphinator:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîß Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Setup Just
        uses: ./.github/actions/setup-just

      - name: üì¶ Install dependencies
        run: just install

      - name: üß™ Run graphinator tests
        run: just test-graphinator

      - name: üìä Upload coverage (graphinator)
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./coverage.xml
          flags: graphinator
          name: graphinator-tests
          fail_ci_if_error: false
          disable_search: true
          verbose: false

  # ============================================================================
  # SCHEMA-INIT SERVICE TESTS - Runs in parallel with all other test jobs
  # ============================================================================
  test-schema-init:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîß Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Setup Just
        uses: ./.github/actions/setup-just

      - name: üì¶ Install dependencies
        run: just install

      - name: üß™ Run schema-init tests
        run: just test-schema-init

      - name: üìä Upload coverage (schema-init)
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./coverage.xml
          flags: schema-init
          name: schema-init-tests
          fail_ci_if_error: false
          disable_search: true
          verbose: false

  # ============================================================================
  # TABLEINATOR SERVICE TESTS - Runs in parallel with all other test jobs
  # ============================================================================
  test-tableinator:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîß Setup Python and UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Setup Just
        uses: ./.github/actions/setup-just

      - name: üì¶ Install dependencies
        run: just install

      - name: üß™ Run tableinator tests
        run: just test-tableinator

      - name: üìä Upload coverage (tableinator)
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./coverage.xml
          flags: tableinator
          name: tableinator-tests
          fail_ci_if_error: false
          disable_search: true
          verbose: false

  # ============================================================================
  # RUST EXTRACTOR TESTS - Runs in parallel with all other test jobs
  # ============================================================================
  test-extractor:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîç Check if Rust extractor exists
        id: check-rust
        run: |
          if [[ -f "extractor/Cargo.toml" ]]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Rust extractor found - tests will run"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "‚è≠Ô∏è No Rust extractor found - skipping Rust tests"
          fi

      - name: ‚è≠Ô∏è Skip remaining steps if Rust extractor doesn't exist
        if: steps.check-rust.outputs.exists == 'false'
        run: |
          echo "::notice title=Rust Tests Skipped::No Rust extractor found in this branch"
          exit 0

      - name: üîß Setup Just
        if: steps.check-rust.outputs.exists == 'true'
        uses: ./.github/actions/setup-just

      - name: ü¶Ä Setup Rust toolchain
        if: steps.check-rust.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: üì¶ Install cargo-llvm-cov
        if: steps.check-rust.outputs.exists == 'true'
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: üíæ Cache Rust dependencies
        if: steps.check-rust.outputs.exists == 'true'
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            extractor/target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-
            ${{ runner.os }}-cargo-

      - name: üß™ Run Rust tests with coverage
        if: steps.check-rust.outputs.exists == 'true'
        run: just test-extractor-cov

      - name: üìä Upload Rust coverage reports
        if: steps.check-rust.outputs.exists == 'true'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./extractor/lcov.info
          flags: extractor
          name: extractor-tests
          fail_ci_if_error: false
          disable_search: true
          verbose: false
        env:
          CODECOV_GCOV_DISABLE: 1
          CODECOV_XCODE_DISABLE: 1
          CODECOV_PYTHON_DISABLE: 1

  # ============================================================================
  # AGGREGATE RESULTS - Waits for all parallel tests to complete
  # ============================================================================
  aggregate-results:
    runs-on: ubuntu-latest
    needs:
      - test-api
      - test-curator
      - test-common
      - test-dashboard
      - test-explore
      - test-graphinator
      - test-schema-init
      - test-tableinator
      - test-extractor
    if: always()

    steps:
      - name: üìä Check test results
        run: |
          echo "Test Results Summary:"
          echo "  API: ${{ needs.test-api.result }}"
          echo "  Curator: ${{ needs.test-curator.result }}"
          echo "  Common: ${{ needs.test-common.result }}"
          echo "  Dashboard: ${{ needs.test-dashboard.result }}"
          echo "  Explore: ${{ needs.test-explore.result }}"
          echo "  Graphinator: ${{ needs.test-graphinator.result }}"
          echo "  Schema-Init: ${{ needs.test-schema-init.result }}"
          echo "  Tableinator: ${{ needs.test-tableinator.result }}"
          echo "  Extractor: ${{ needs.test-extractor.result }}"

          # Check if any test job failed
          if [[ "${{ needs.test-api.result }}" == "failure" ]] || \
             [[ "${{ needs.test-curator.result }}" == "failure" ]] || \
             [[ "${{ needs.test-common.result }}" == "failure" ]] || \
             [[ "${{ needs.test-dashboard.result }}" == "failure" ]] || \
             [[ "${{ needs.test-explore.result }}" == "failure" ]] || \
             [[ "${{ needs.test-graphinator.result }}" == "failure" ]] || \
             [[ "${{ needs.test-schema-init.result }}" == "failure" ]] || \
             [[ "${{ needs.test-tableinator.result }}" == "failure" ]] || \
             [[ "${{ needs.test-extractor.result }}" == "failure" ]]; then
            echo "‚ùå One or more test jobs failed"
            exit 1
          fi

          echo "‚úÖ All test jobs passed!"
