---
# This is the primary test workflow that runs all unit and integration tests.
# It is called by the build.yml workflow and can also be triggered independently.
# For E2E and browser testing, see e2e-test.yml.
name: Test

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches:
      - main
    paths:
      - "**/*.py"
      - "**/pyproject.toml"
      - "**/uv.lock"
      - "extractor/rustextractor/**/*.rs"
      - "extractor/rustextractor/**/Cargo.toml"
      - ".github/workflows/test.yml"
  pull_request:
    branches:
      - main
    paths:
      - "**/*.py"
      - "**/pyproject.toml"
      - "**/uv.lock"
      - "extractor/rustextractor/**/*.rs"
      - "extractor/rustextractor/**/Cargo.toml"
      - ".github/workflows/test.yml"

env:
  CI: true
  PYTHON_VERSION: "3.13"

permissions:
  contents: read
  pull-requests: write  # Required for coverage report comments
  # Note: statuses: write is only needed for PRs and must be granted by the caller when used as a reusable workflow

jobs:
  python-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history for diff

      - name: üîç Check if tests needed
        id: check-tests
        if: github.event_name == 'pull_request'
        run: |
          # Check if any Python files or test files changed
          if git diff --name-only "origin/${{ github.base_ref }}...HEAD" | grep -qE "\.(py|yaml|yml|toml)$|^tests/"; then
            echo "needed=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Tests needed - Python or config files changed"
          else
            echo "needed=false" >> "$GITHUB_OUTPUT"
            echo "‚è≠Ô∏è No Python or config files changed - tests can be skipped"
          fi

      - name: ‚è≠Ô∏è Skip remaining steps if not needed
        if: github.event_name == 'pull_request' && steps.check-tests.outputs.needed == 'false'
        run: |
          echo "::notice title=Tests Skipped::No relevant files changed, skipping tests"
          exit 0

      - name: üîß Setup Python and UV
        if: github.event_name != 'pull_request' || steps.check-tests.outputs.needed == 'true'
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üîß Setup Just
        if: github.event_name != 'pull_request' || steps.check-tests.outputs.needed == 'true'
        uses: ./.github/actions/setup-just

      # Test cache (pytest)
      - name: üíæ Cache test results
        if: github.event_name != 'pull_request' || steps.check-tests.outputs.needed == 'true'
        uses: actions/cache@v5
        with:
          path: |
            .pytest_cache
            .coverage
            htmlcov
          key: ${{ runner.os }}-test-unit-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-test-unit-
            ${{ runner.os }}-test-

      - name: üì¶ Install dependencies
        if: github.event_name != 'pull_request' || steps.check-tests.outputs.needed == 'true'
        run: |
          just install
          # Install workspace packages
          uv pip install -e dashboard
          uv pip install -e common

      - name: üß™ Run unit tests with coverage (excluding E2E)
        if: github.event_name != 'pull_request' || steps.check-tests.outputs.needed == 'true'
        run: |
          # Run tests with coverage - generates XML, JSON, and terminal reports
          just test-cov

      - name: üìã Process coverage reports
        id: coverage-setup
        if: github.event_name != 'pull_request' || steps.check-tests.outputs.needed == 'true'
        run: |
          jq '{
            total: {
              statements: {total: .totals.num_statements, covered: .totals.covered_lines},
              lines: {total: .totals.num_statements, covered: .totals.covered_lines},
              functions: {total: 0, covered: 0},
              branches: {total: 0, covered: 0}
            }
          }' coverage.json > coverage-summary.json
          echo "coverage-exists=true" >> "$GITHUB_OUTPUT"

      - name: üìä Upload Python coverage reports
        if: github.event_name != 'pull_request' || steps.check-tests.outputs.needed == 'true'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./coverage.xml
          flags: python
          name: python-coverage
          fail_ci_if_error: false
          disable_search: true  # Don't auto-search for coverage files
          verbose: false  # Reduce output noise
        env:
          # Disable unnecessary coverage tool detection
          CODECOV_GCOV_DISABLE: 1
          CODECOV_XCODE_DISABLE: 1

      - name: üìä Coverage Report
        if: github.event_name == 'pull_request' && steps.coverage-setup.outputs.coverage-exists == 'true'
        uses: slavcodev/coverage-monitor-action@398c4cbbb710e549a8407fdef96ae8b9454d0463 # v1.10.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          coverage_path: "coverage-summary.json"
          coverage_format: "json-summary"
          status_context: "Coverage Report"
          comment_context: "Coverage Report"

  rust-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üîÄ Checkout repository
        uses: actions/checkout@v6

      - name: üîç Check if Rust extractor exists
        id: check-rust
        run: |
          if [[ -f "extractor/rustextractor/Cargo.toml" ]]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Rust extractor found - tests will run"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "‚è≠Ô∏è No Rust extractor found - skipping Rust tests"
          fi

      - name: ‚è≠Ô∏è Skip remaining steps if Rust extractor doesn't exist
        if: steps.check-rust.outputs.exists == 'false'
        run: |
          echo "::notice title=Rust Tests Skipped::No Rust extractor found in this branch"
          exit 0

      - name: ü¶Ä Setup Rust toolchain
        if: steps.check-rust.outputs.exists == 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: üì¶ Install cargo-llvm-cov
        if: steps.check-rust.outputs.exists == 'true'
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: üíæ Cache Rust dependencies
        if: steps.check-rust.outputs.exists == 'true'
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            extractor/rustextractor/target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-
            ${{ runner.os }}-cargo-

      - name: üß™ Run Rust tests with coverage
        if: steps.check-rust.outputs.exists == 'true'
        run: |
          cd extractor/rustextractor
          cargo llvm-cov test --verbose --lcov --output-path lcov.info

      - name: üìä Upload Rust coverage reports
        if: steps.check-rust.outputs.exists == 'true'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: SimplicityGuy/discogsography
          files: ./extractor/rustextractor/lcov.info
          flags: rust
          name: rust-coverage
          fail_ci_if_error: false
          disable_search: true  # Don't auto-search for coverage files
          verbose: false  # Reduce output noise
        env:
          # Disable unnecessary coverage tool detection
          CODECOV_GCOV_DISABLE: 1
          CODECOV_XCODE_DISABLE: 1
          CODECOV_PYTHON_DISABLE: 1  # Only lcov.info for Rust
